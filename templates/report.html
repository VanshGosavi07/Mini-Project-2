<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Breast Cancer Diagnosis Report</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Add html2pdf.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      :root {
        --primary-color: #6a0572;
        --secondary-color: #f8e1ff;
        --accent-color: #a100ff;
        --warning-color: #ff9800;
        --danger-color: #e53935;
        --success-color: #43a047;
        --light-gray: #f3f4f6;
      }

      body {
        background-color: var(--light-gray);
        font-family: "Poppins", sans-serif;
      }

      .container {
        margin-top: 30px;
        margin-bottom: 30px;
        background: linear-gradient(to bottom, #ffffff, #f3e5f5);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      }

      .report-header {
        background: var(--primary-color);
        color: white;
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 8px;
        text-align: center;
        font-size: 1.8rem;
        font-weight: bold;
      }

      .section {
        margin-bottom: 30px;
        border-radius: 10px;
        padding: 20px;
        background: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .section-title {
        font-size: 1.6rem;
        color: var(--primary-color);
        border-bottom: 3px solid var(--accent-color);
        padding-bottom: 10px;
        margin-bottom: 15px;
        font-weight: bold;
      }

      .patient-info {
        height: 100%;
      }

      .patient-info th {
        background-color: var(--primary-color);
        color: white;
        width: 40%;
      }

      .disease-malignant {
        color: var(--danger-color);
        font-weight: bold;
        font-size: 1.2rem;
      }

      .disease-benign {
        color: var(--success-color);
        font-weight: bold;
        font-size: 1.2rem;
      }

      .img-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: var(--secondary-color);
        border-radius: 10px;
        padding: 20px;
        border: 2px solid var(--accent-color);
      }

      .img-container img {
        max-width: 100%;
        height: 320px;
        object-fit: contain;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .doctor-info {
        background: var(--secondary-color);
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid var(--accent-color);
      }

      .precautions-section {
        background: #fff3e0;
        border-left: 5px solid var(--warning-color);
      }

      .findings-section h4 {
        color: var(--accent-color);
        border-bottom: 1px solid var(--secondary-color);
        padding-bottom: 8px;
        margin-top: 15px;
        font-weight: 600;
      }

      .list-group-item {
        border-left: 4px solid var(--primary-color);
        font-size: 1.1rem;
      }

      .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: var(--secondary-color);
      }

      .table-primary {
        background-color: var(--primary-color) !important;
        color: white;
      }

      .card.bg-light {
        background-color: var(--secondary-color) !important;
      }

      .alert-warning {
        background-color: #fff3e0;
        border-color: var(--warning-color);
      }
      .custom-btn {
        padding: 10px 20px;
        font-size: 1rem;
        font-weight: bold;
        border-radius: 8px;
        border: none;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .btn-chat {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--accent-color)
        );
        color: white;
      }

      .btn-chat:hover {
        background: linear-gradient(
          to right,
          var(--accent-color),
          var(--primary-color)
        );
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .btn-download {
        background: var(--primary-color);
        color: white;
      }

      .btn-download:hover {
        background: var(--accent-color);
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      /* PDF-specific styles that will only apply when generating the PDF */
      @media print {
        body {
          background-color: white;
        }

        .container {
          margin: 0;
          padding: 15px;
          box-shadow: none;
          background: white;
        }

        .custom-btn {
          display: none;
        }
      }
    </style>
  </head>
  <body>
      <div class="container" id="report-container">
          <div class="report-header">Breast Cancer Diagnosis Report</div>
          <div class="d-flex justify-content-end mb-3">
              <button class="custom-btn btn-chat me-2"
                      onclick="window.location.href='{{ url_for('chat_page') }}'">
                  Chat with Report
              </button>
              <button class="custom-btn btn-download" id="downloadBtn">
                  Download Report
              </button>
          </div>
          <div class="row mb-4">
              <div class="col-md-6">
                  <div class="section patient-info">
                      <h3 class="section-title">Patient Information</h3>
                      <table class="table table-bordered">
                          <tbody>
                              <tr>
                                  <th>Name</th>
                                  <td>{{ name }}</td>
                              </tr>
                              <tr>
                                  <th>Date of Birth</th>
                                  <td>{{ dob }}</td>
                              </tr>
                              <tr>
                                  <th>Age</th>
                                  <td>{{ age }}</td>
                              </tr>
                              <tr>
                                  <th>Date of Report</th>
                                  <td>{{ current_date }}</td>
                              </tr>
                              <tr>
                                  <th>Disease Name</th>
                                  <td>{{ disease_name }}</td>
                              </tr>
                              <tr>
                                  <th>Disease Level</th>
                                  <td class="{{ 'disease-malignant' if 'Malignant' in diseases_level[0] else 'disease-benign' }}">
                                      {{ diseases_level[0] }}
                                  </td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
              </div>
              <div class="col-md-6 d-flex">
                  <div class="img-container w-100">
                      {% for image_path in image_paths %}
                      <img src="{{ url_for('static', filename=image_path) }}"
                           class="img-fluid"
                           alt="Medical Scan Image" />
                      {% endfor %}
                  </div>
              </div>
          </div>

          {% if clinical_history %}
          <div class="section">
              <h3 class="section-title">Clinical History</h3>
              <div class="card p-3">
                  <p class="mb-0">{{ clinical_history }}</p>
              </div>
          </div>
          {% endif %} {% if symptoms %}
          <div class="section">
              <h3 class="section-title">Symptoms Description</h3>
              <ul class="list-group">
                  {% for symptom in symptoms %}
                  <li class="list-group-item">{{ symptom }}</li>
                  {% endfor %}
              </ul>
          </div>
          {% endif %} {% if data['clinical examination'] or data['imaging studies']
          or data['pathological staging'] %}
          <div class="section findings-section">
              <h3 class="section-title">Detailed Findings</h3>

              {% if data['clinical examination'] %}
              <h4>Clinical Examination</h4>
              <p>{{ data['clinical examination'] }}</p>
              {% endif %} {% if data['imaging studies'] %}
              <h4>Imaging Studies</h4>
              <table class="table table-striped table-bordered">
                  <thead>
                      <tr class="table-primary">
                          <th style="color: black; font-weight: bold">Imaging Type</th>
                          <th style="color: black; font-weight: bold">Findings</th>
                      </tr>
                  </thead>

                  <tbody>
                      {% for study in data['imaging studies'] %}
                      <tr>
                          <td>{{ study.split(':')[0] }}</td>
                          <td>{{ study.split(':')[1] }}</td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
              {% endif %} {% if data['pathological staging'] %}
              <h4>Pathological Staging</h4>
              <div class="card bg-light">
                  <div class="card-body">{{ data['pathological staging'] }}</div>
              </div>
              {% endif %}
          </div>
          {% endif %} {% if data['precautions'] %}
          <div class="section precautions-section">
              <h3 class="section-title">Precautions to Take</h3>
              <div class="alert alert-warning">
                  <ul class="mb-0">
                      {% for precaution in data['precautions'] %}
                      <li>{{ precaution }}</li>
                      {% endfor %}
                  </ul>
              </div>
          </div>
          {% endif %}

          <div class="row">
              {% if data['Recommended diet'] %}
              <div class="col-md-6">
                  <div class="section">
                      <h3 class="section-title">Recommended Diet</h3>
                      <ul class="list-group">
                          {% for diet in data['Recommended diet'] %}
                          <li class="list-group-item">{{ diet }}</li>
                          {% endfor %}
                      </ul>
                  </div>
              </div>
              {% endif %} {% if data['Recommended exercise'] %}
              <div class="col-md-6">
                  <div class="section">
                      <h3 class="section-title">Recommended Exercise</h3>
                      <ul class="list-group">
                          {% for exercise in data['Recommended exercise'] %}
                          <li class="list-group-item">{{ exercise }}</li>
                          {% endfor %}
                      </ul>
                  </div>
              </div>
              {% endif %}
          </div>
          {% if user_type == 'doctor'%}
          <div class="section doctor-info">
              <h3 class="section-title">Report Prepared By</h3>
              <div class="row">
                  <div class="col-md-8">
                      <p><strong>Doctor's Name:</strong> {{ prepared_by }}</p>
                      <p><strong>Date of Report:</strong> {{ current_date }}</p>
                  </div>
              </div>
          </div>
          {% endif %}
      </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document
        .getElementById("downloadBtn")
        .addEventListener("click", function () {
          // Create a spinner or loading indicator
          const btn = this;
          const originalText = btn.innerHTML;
          btn.innerHTML = "Generating PDF...";
          btn.disabled = true;

          // Get the report container
          const element = document.getElementById("report-container");

          // Define PDF options
          const opt = {
            margin: 10,
            filename: "Breast_Cancer_Diagnosis_Report.pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              logging: false,
            },
            jsPDF: {
              unit: "mm",
              format: "a4",
              orientation: "portrait",
            },
          };

          // Hide the download button temporarily for the PDF
          const btnContainer = document.querySelector(
            ".d-flex.justify-content-end"
          );
          const displayStyle = btnContainer.style.display;
          btnContainer.style.display = "none";

          // Generate and save the PDF
          html2pdf()
            .from(element)
            .set(opt)
            .save()
            .then(function () {
              // Restore the button container
              btnContainer.style.display = displayStyle;

              // Reset button
              btn.innerHTML = originalText;
              btn.disabled = false;
            });
        });
    </script>
  </body>
</html>
